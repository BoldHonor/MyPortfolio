import * as THREE from "./build/three.module.js";
import { EffectComposer } from './examples/jsm/postprocessing/EffectComposer.js';
import { RenderPass } from './examples/jsm/postprocessing/RenderPass.js';
import { UnrealBloomPass } from './examples/jsm/postprocessing/UnrealBloomPass.js';
import { GLTFLoader } from './examples/jsm/loaders/GLTFLoader.js'
import { OrbitControls } from './examples/jsm/controls/OrbitControls.js';
import { FirstPersonControls } from './examples/jsm/controls/FirstPersonControls.js';
import { BokehPass } from './examples/jsm/postprocessing/BokehPass.js';

var renderer,effectDiv=document.getElementById("sideScroll"),height=effectDiv.clientHeight,width=effectDiv.clientWidth,camera="",scene="";effectDiv.style.height="100%",effectDiv.style.width="100%",effectDiv.style.position="fixed";var currentTIme=Date.now(),deltaTime=1;const PARTICLE_SIZE=2;let lookAt;var phoneSpeed=0,phoneCurrentSpeed=1,onHover=document.getElementsByClassName("onHover"),page=document.getElementById("page"),loaderScreen=document.getElementById("loader"),ins=document.getElementById("instruction"),insimg=document.getElementById("instructionImage"),Explore=document.getElementById("explore"),linkPage=document.getElementById("linkPage");let pageNavigator=function(){};var target,phoneup,phonedown,phoneright,phoneleft,phonemove,phoneback,phoneControls,phoneLookSpeed,phoneLookStatus,direction,phi,theta,obj,AboutME,Projects,Resume,intersects,pageNavigatorLinks={AboutMe:{link:"./AboutME.html",active:!1},Resume:{link:"./Project Descriptions/cv.html",active:!1},Projects:{link:"./Projects.html",active:!1}};let maxX,maxY,maxZ,minX,minY,minZ;maxX=145,minX=-132,minY=6,maxY=20,maxZ=31,minZ=-109;let isPhone=!0;function detectMob(){return[/Android/i,/webOS/i,/iPhone/i,/iPad/i,/iPod/i,/BlackBerry/i,/Windows Phone/i].some(e=>navigator.userAgent.match(e))}function degToRad(e){return 3.14*e/360}function startRotation(e){direction=e,phoneLookStatus=1}function stopRotation(e){direction=e,phoneLookStatus=0}function phoneControlsUpdate(){pageNavigator();var e=camera.position;switch(direction){case"up":phi+=-phoneLookSpeed*phoneLookStatus;break;case"down":phi+=phoneLookSpeed*phoneLookStatus;break;case"right":theta+=-phoneLookSpeed*phoneLookStatus;break;case"left":theta+=phoneLookSpeed*phoneLookStatus}target.setFromSphericalCoords(1,phi,theta).add(e),camera.lookAt(target)}isPhone=detectMob(),console.log("is phone test "+isPhone),isPhone&&(target=new THREE.Vector3(-.631,13.313,-27.756),phoneup=document.getElementById("up"),phonedown=document.getElementById("down"),phoneright=document.getElementById("right"),phoneleft=document.getElementById("left"),phonemove=document.getElementById("move"),phoneback=document.getElementById("back"),phoneControls=[phoneup,phonedown,phoneright,phoneleft],phoneLookSpeed=degToRad(1),phoneLookStatus=1,phi=degToRad(150),theta=degToRad(-150),phoneControls.some(e=>{e.addEventListener("touchstart",function(){startRotation(this.id)}),e.addEventListener("mousedown",function(){startRotation(this.id)}),e.addEventListener("touchend",function(){stopRotation(this.id)}),e.addEventListener("mouseup",function(){stopRotation(this.id)})})),page.style.visibility="hidden",document.getElementById("instruction").style.visibility="hidden",window.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),!1},window.addEventListener("resize",onWindowResize,!1),camera=isPhone?new THREE.PerspectiveCamera(60,effectDiv.clientWidth/effectDiv.clientHeight,.01,80):new THREE.PerspectiveCamera(40,effectDiv.clientWidth/effectDiv.clientHeight,.01,300),(renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0})).setPixelRatio(+window.devicePixelRatio/2),renderer.extensions.get("EXT_color_buffer_float"),isPhone?renderer.setSize(window.innerWidth,window.innerHeight):renderer.setSize(effectDiv.clientWidth,effectDiv.clientHeight),effectDiv.appendChild(renderer.domElement),camera.position.set(128,7.911,-36.6),scene=new THREE.Scene;const clock=new THREE.Clock;isPhone?(renderer.setClearColor("#787676"),scene.fog=new THREE.Fog(7894646,.3,85),camera.rotation.set(0,2,0),renderer.setPixelRatio(+window.devicePixelRatio/4)):(renderer.setClearColor("#787676"),scene.fog=new THREE.Fog(7894646,.3,190),camera.rotation.set(10,-80,-10),renderer.setPixelRatio(window.devicePixelRatio));const loa=new THREE.ObjectLoader,mouse=new THREE.Vector2,raycaster=new THREE.Raycaster,black=new THREE.Color(0,0,0),orange=new THREE.Color(206,87,9);isPhone?loa.load("FinalAssets/Models/scene MOBILE.json",function(e){function t(e){pageNavigatorLinks[e].active||(console.log(pageNavigatorLinks[e].link),linkPage.innerHTML=e,linkPage.style.display="block",pageNavigatorLinks[e].active=!0)}obj=e,scene.add(obj),AboutME=obj.getObjectByName("Plane029"),Projects=obj.getObjectByName("Plane028"),Resume=obj.getObjectByName("Plane030"),page.style.visibility="visible",loaderScreen.remove(),pageNavigator=function(){camera.position.distanceTo(AboutME.position)<40?t("AboutMe"):camera.position.distanceTo(Resume.position)<40?t("Resume"):camera.position.distanceTo(Projects.position)<40?t("Projects"):(linkPage.style.display="none",pageNavigatorLinks.AboutMe.active=!1,pageNavigatorLinks.Resume.active=!1,pageNavigatorLinks.Projects.active=!1)},linkPage.addEventListener("click",function(){window.open(pageNavigatorLinks[this.innerHTML].link)})},function(e){console.log(e.loaded/e.total*100+"% loaded")},function(e){console.error("An error happened")}):(document.getElementById("motioncontrols").remove(),document.getElementById("controls").remove(),loa.load("FinalAssets/Models/scene1.json",function(e){function t(e){pageNavigatorLinks[e].active||(console.log(pageNavigatorLinks[e].link),linkPage.innerHTML=e,linkPage.style.display="block",pageNavigatorLinks[e].active=!0)}obj=e,console.log("3comlete"),scene.add(obj),AboutME=obj.getObjectByName("Plane029"),Projects=obj.getObjectByName("Plane028"),Resume=obj.getObjectByName("Plane030"),page.style.visibility="visible",loaderScreen.remove(),pageNavigator=function(){camera.position.distanceTo(AboutME.position)<40?t("AboutMe"):camera.position.distanceTo(Resume.position)<40?t("Resume"):camera.position.distanceTo(Projects.position)<40?t("Projects"):(linkPage.style.display="none",pageNavigatorLinks.AboutMe.active=!1,pageNavigatorLinks.Resume.active=!1,pageNavigatorLinks.Projects.active=!1)},linkPage.addEventListener("click",function(){window.open(pageNavigatorLinks[this.innerHTML].link)}),Explore.addEventListener("click",function(){controls.movementSpeed=12,document.getElementById("instruction").style.visibility="visible",document.getElementById("welcome").style.display="none",document.getElementById("instructionImage").src="FinalAssets/Loader/instruction.png"}),window.addEventListener("mousemove",function(e){mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=2*-(e.clientY/window.innerHeight)+1,raycaster.setFromCamera(mouse,camera),void 0===(intersects=raycaster.intersectObjects([AboutME,Projects,Resume]))[0]?(AboutME.material.emissive=black,Resume.material.emissive=black,Projects.material.emissive=black):intersects[0].distance<40&&(intersects[0].object.material.emissive=orange,intersects[0].object.material.emissiveIntensity=.003)}),document.body.addEventListener("click",function(e){if(raycaster.setFromCamera(mouse,camera),(intersects=raycaster.intersectObjects([AboutME,Projects,Resume]))[0].distance<45)switch(intersects[0].object.name){case"Plane029":window.open("./AboutME.html","_blank"),console.log("ji");break;case"Plane028":window.open("./Projects.html","_blank");break;case"Plane030":window.open("./Project Descriptions/cv.html","_blank")}})},function(e){console.log(e.loaded/e.total*100+"% loaded")},function(e){console.error("An error happened")})),console.log("1comlete");const renderScene=new RenderPass(scene,camera),bloomPass=new UnrealBloomPass(new THREE.Vector2(effectDiv.clientWidth,effectDiv.clientHeight),1.5,.4,.85);bloomPass.threshold=.5,bloomPass.strength=.3,bloomPass.radius=.4;let composer;composer=new EffectComposer(renderer),composer.addPass(renderScene),composer.addPass(bloomPass),console.log("2comlete");let controls;function moveFrwd(){camera.getWorldDirection(lookAt),camera.position.add(lookAt.multiplyScalar(phoneSpeed*deltaTime))}function animate(){deltaTime=Date.now()-currentTIme,deltaTime/=100,currentTIme=Date.now(),isPhone?(composer.render(),moveFrwd(),phoneControlsUpdate()):(pageNavigator(),controls.update(clock.getDelta()),composer.render()),camera.position.x>maxX&&(camera.position.x=maxX),camera.position.x<minX&&(camera.position.x=minX),camera.position.y>maxY&&(camera.position.y=maxY),camera.position.y<minY&&(camera.position.y=minY,console.log("out of bounds")),camera.position.z>maxZ&&(camera.position.z=maxZ),camera.position.z<minZ&&(camera.position.z=minZ),requestAnimationFrame(animate)}function onWindowResize(){camera.aspect=effectDiv.clientWidth/effectDiv.clientHeight,isPhone?renderer.setSize(window.innerWidth,window.innerHeight):renderer.setSize(effectDiv.clientWidth,effectDiv.clientHeight),camera.updateProjectionMatrix(),void 0!==controls&&controls.handleResize()}isPhone?(lookAt=new THREE.Vector3(0,0,0),Explore.addEventListener("touchstart",function(){document.getElementById("controls").style.zIndex="3",ins.style.visibility="visible",document.getElementById("welcome").style.display="none",insimg.src="FinalAssets/Loader/mobileInstructions.png",insimg.style.width="100%",insimg.style.height="auto",ins.style.backgroundColor="rgba(226, 141, 14, 0.747)",ins.style.width="100%",ins.style.display="flex",ins.style.justifyContent="center",ins.remove()}),Explore.addEventListener("click",function(){ins.style.visibility="visible",document.getElementById("welcome").style.display="none",document.getElementById("instructionImage").src="FinalAssets/Loader/mobileInstructions.png",document.getElementById("controls").style.zIndex="3",ins.style.width="100%",ins.style.height="100%",ins.style.display="flex",ins.style.justifyContent="center",ins.remove()})):(controls=new FirstPersonControls(camera,renderer.domElement),controls.movementSpeed=0,controls.lookSpeed=.06,controls.constrainVertical=!0,controls.verticalMax=1.9,controls.verticalMin=1.5,controls.mouseDragOn=!1,controls.activeLook=!0),console.log("4comlete"),isPhone&&(phonemove.addEventListener("touchstart",function(){phoneSpeed=phoneCurrentSpeed}),phonemove.addEventListener("touchend",function(){phoneSpeed=0}),phonemove.addEventListener("mousedown",function(){phoneSpeed=phoneCurrentSpeed}),phonemove.addEventListener("mouseup",function(){phoneSpeed=0}),phoneback.addEventListener("touchstart",function(){phoneSpeed=-phoneCurrentSpeed}),phoneback.addEventListener("touchendt",function(){phoneSpeed=0}),phoneback.addEventListener("mousedown",function(){phoneSpeed=-phoneCurrentSpeed}),phoneback.addEventListener("mouseup",function(){phoneSpeed=0})),onWindowResize(),animate();